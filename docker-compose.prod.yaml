x-app-default: &app-default
    image: ghcr.io/naufalkhaddafy/blog-mahad:latest
    restart: always
    # We explicitly map variables to ensure they are passed from host .env
    environment:
        APP_ENV: production
        APP_KEY: ${APP_KEY}
        APP_URL: ${APP_URL}
        APP_DEBUG: ${APP_DEBUG:-false}
        
        DB_CONNECTION: ${DB_CONNECTION}
        DB_HOST: ${DB_HOST}
        DB_PORT: ${DB_PORT}
        DB_DATABASE: ${DB_DATABASE}
        DB_USERNAME: ${DB_USERNAME}
        DB_PASSWORD: ${DB_PASSWORD}

        REDIS_HOST: ${REDIS_HOST}
        REDIS_PASSWORD: ${REDIS_PASSWORD}
        REDIS_PORT: ${REDIS_PORT}

        CACHE_STORE: ${CACHE_STORE}
        QUEUE_CONNECTION: ${QUEUE_CONNECTION}
        SESSION_DRIVER: ${SESSION_DRIVER}

        REVERB_APP_ID: ${REVERB_APP_ID}
        REVERB_APP_KEY: ${REVERB_APP_KEY}
        REVERB_APP_SECRET: ${REVERB_APP_SECRET}
        REVERB_HOST: "0.0.0.0"
        REVERB_PORT: 8080
        REVERB_SCHEME: ${REVERB_SCHEME}
        N8N_WEBHOOK_URL: ${N8N_WEBHOOK_URL}

        OCTANE_SERVER: frankenphp
    networks:
        - public_network
        - database_network

services:
    app:
        <<: *app-default
        container_name: blog-mahad
        ports:
            - "127.0.0.1:8001:80"
        volumes:
            - ./storage:/app/storage
            - ./bootstrap/cache:/app/bootstrap/cache
        depends_on:
            - reverb

    reverb:
        <<: *app-default
        container_name: blog-mahad-reverb
        command: ["reverb"]
        # No host port - access via internal network through Nginx Proxy Manager
        # NPM should proxy WebSocket to: blog-mahad-reverb:8080
        healthcheck:
            disable: true

    scheduler:
        <<: *app-default
        container_name: blog-mahad-scheduler
        command: ["scheduler"]
        volumes:
            - ./storage:/app/storage
            - ./bootstrap/cache:/app/bootstrap/cache
        healthcheck:
            disable: true
        depends_on:
            - app

    queue:
        <<: *app-default
        container_name: blog-mahad-queue
        command: ["queue"]
        volumes:
            - ./storage:/app/storage
            - ./bootstrap/cache:/app/bootstrap/cache
        healthcheck:
            disable: true
        depends_on:
            - app

networks:
    public_network:
        external: true
    database_network:
        external: true

