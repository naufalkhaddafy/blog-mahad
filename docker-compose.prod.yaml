services:
    app:
        build:
            context: .
            dockerfile: docker/production/Dockerfile
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad
        restart: always
        ports:
            - "8001:80" # Bind to host 8001, easy for NPM upstream
        environment:
            APP_ENV: production
            APP_DEBUG: "false"
            APP_KEY: ${APP_KEY}
            APP_URL: ${APP_URL}
            
            # Database (Shared Network)
            DB_CONNECTION: mysql
            DB_HOST: shared_mariadb
            DB_PORT: 3306
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}

            # Redis (Shared Network)
            REDIS_HOST: shared_redis
            REDIS_PASSWORD: ${REDIS_PASSWORD}
            REDIS_PORT: 6379

            # Reverb
            REVERB_APP_ID: ${REVERB_APP_ID}
            REVERB_APP_KEY: ${REVERB_APP_KEY}
            REVERB_APP_SECRET: ${REVERB_APP_SECRET}
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: https # Proxied via NPM

            # Octane
            OCTANE_SERVER: frankenphp
        volumes:
            # Persist Storage & Logs locally
            - ./storage:/app/storage
        networks:
            - public_network
            - database_network
        depends_on:
            - reverb

    reverb:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-reverb
        restart: always
        command: php artisan reverb:start --host=0.0.0.0 --port=8080
        ports:
             - "8080:8080" # Expose for NPM WebSocket support
        environment:
            APP_ENV: production
            APP_DEBUG: "false"
            REDIS_HOST: shared_redis
            REDIS_PASSWORD: ${REDIS_PASSWORD}
            REVERB_APP_ID: ${REVERB_APP_ID}
            REVERB_APP_KEY: ${REVERB_APP_KEY}
            REVERB_APP_SECRET: ${REVERB_APP_SECRET}
        networks:
            - public_network
            - database_network

    scheduler:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-scheduler
        restart: always
        command: php artisan schedule:work
        environment:
            APP_ENV: production
            DB_HOST: shared_mariadb
            DB_PASSWORD: ${DB_PASSWORD}
            REDIS_HOST: shared_redis
            REDIS_PASSWORD: ${REDIS_PASSWORD}
        networks:
            - database_network # Only needs access to DB/Redis, no public access
        volumes:
            - ./storage:/app/storage

    queue:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-queue
        restart: always
        command: php artisan queue:work --tries=3
        environment:
            APP_ENV: production
            DB_HOST: shared_mariadb
            DB_PASSWORD: ${DB_PASSWORD}
            REDIS_HOST: shared_redis
            REDIS_PASSWORD: ${REDIS_PASSWORD}
        networks:
            - database_network
        volumes:
            - ./storage:/app/storage

networks:
    public_network:
        external: true
    database_network:
        external: true
