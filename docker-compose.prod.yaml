services:
    app:
        build:
            context: .
            dockerfile: docker/production/Dockerfile
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad
        restart: always
        ports:
            - "8001:80" # Bind to host 8001, easy for NPM upstream
        env_file: 
            - .env
        environment:
            # Overrides or additional specific vars if needed.
            # But mostly we rely on .env now for DB_CONNECTION, etc.
            OCTANE_SERVER: frankenphp
        volumes:
            - ./storage:/app/storage
        networks:
            - public_network
            - database_network
        depends_on:
            - reverb

    reverb:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-reverb
        restart: always
        # Fix: Ensure config is cached so it reads ENV vars correctly before starting
        command: sh -c "php artisan config:cache && php artisan reverb:start --host=0.0.0.0 --port=8080"
        ports:
             - "8080:8080"
        env_file:
            - .env
        networks:
            - public_network
            - database_network

    scheduler:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-scheduler
        restart: always
        # Fix: Ensure config is cached
        command: sh -c "php artisan config:cache && php artisan schedule:work"
        env_file:
            - .env
        networks:
            - database_network
        volumes:
            - ./storage:/app/storage

    queue:
        image: ghcr.io/naufalkhaddafy/blog-mahad:latest
        container_name: blog-mahad-queue
        restart: always
        command: sh -c "php artisan config:cache && php artisan queue:work --tries=3"
        env_file:
            - .env
        networks:
            - database_network
        volumes:
            - ./storage:/app/storage

networks:
    public_network:
        external: true
    database_network:
        external: true
